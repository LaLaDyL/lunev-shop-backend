const { Pool } = require('pg');
const fs = require('fs');

const pool = new Pool({
  user: 'postgres',
  host: 'localhost',
  database: 'shop_lunev',
  password: '123',
  port: 5432,
});

async function importProducts() {
  let client;
  try {
    client = await pool.connect();
    console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤...\n');
    
    // 1. –ß–∏—Ç–∞–µ–º products.json
    const productsData = JSON.parse(fs.readFileSync('products.json', 'utf8'));
    console.log(`üì¶ –ù–∞–π–¥–µ–Ω–æ ${productsData.length} —Ç–æ–≤–∞—Ä–æ–≤ –≤ JSON\n`);
    
    // 2. –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–æ–≤–∞—Ä—ã
    console.log('üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–æ–≤–∞—Ä—ã...');
    await client.query('DELETE FROM products');
    await client.query('ALTER SEQUENCE products_product_id_seq RESTART WITH 1');
    console.log('‚úÖ –°—Ç–∞—Ä—ã–µ —Ç–æ–≤–∞—Ä—ã —É–¥–∞–ª–µ–Ω—ã\n');
    
    // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    console.log('üìÅ –†–∞–±–æ—Ç–∞–µ–º —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏...');
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º –µ—Å—Ç—å –ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const catResult = await client.query('SELECT COUNT(*) FROM categories');
    if (parseInt(catResult.rows[0].count) === 0) {
      console.log('üìù –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...');
      const categories = {
        'telephone': '–°–º–∞—Ä—Ç—Ñ–æ–Ω—ã',
        'consoles': '–ò–≥—Ä–æ–≤—ã–µ –∫–æ–Ω—Å–æ–ª–∏', 
        'headphone': '–ù–∞—É—à–Ω–∏–∫–∏',
        'port-consoles': '–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Å–æ–ª–∏',
        'washmashine': '–¢–µ—Ö–Ω–∏–∫–∞ –¥–ª—è –¥–æ–º–∞',
        'notebook': '–ù–æ—É—Ç–±—É–∫–∏',
        'poloroid': '–§–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∞',
        'watches': '–ß–∞—Å—ã',
        'TV': '–¢–µ–ª–µ–≤–∏–∑–æ—Ä—ã'
      };
      
      for (const [slug, name] of Object.entries(categories)) {
        await client.query(
          'INSERT INTO categories (name, slug) VALUES ($1, $2)',
          [name, slug]
        );
      }
      console.log('‚úÖ 9 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω—ã\n');
    } else {
      console.log('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç\n');
    }
    
    // 4. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã
    console.log('üì• –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã...');
    let importedCount = 0;
    
    for (const product of productsData) {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ main_image
      let categoryId = 1; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ã
      
      if (product.main_image.includes('telephone')) categoryId = 1;
      else if (product.main_image.includes('consoles')) categoryId = 2;
      else if (product.main_image.includes('headphone')) categoryId = 3;
      else if (product.main_image.includes('port-consoles')) categoryId = 4;
      else if (product.main_image.includes('wash')) categoryId = 5;
      else if (product.main_image.includes('notebook')) categoryId = 6;
      else if (product.main_image.includes('poloroid')) categoryId = 7;
      else if (product.main_image.includes('watches')) categoryId = 8;
      else if (product.main_image.includes('TV')) categoryId = 9;
      
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –±–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã
      const bonusMatch = product.bonus ? product.bonus.match(/\d+/) : null;
      const bonusPoints = bonusMatch ? parseInt(bonusMatch[0].replace(/\s/g, '')) : 0;
      
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      const description = Array.isArray(product.description) 
        ? product.description.join(' ') 
        : (product.description || '');
      
      const colorOptions = product.color_options || '';
      
      // –í JSON –ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è "delivery", –∞ –Ω–µ "delivery_options"
      const deliveryArray = product.delivery || [];
      
      try {
        await client.query(
          `INSERT INTO products (
            name, description, price, category_id, bonus_points, 
            main_image, images, memory_options, color_options, 
            delivery_options, stock_quantity
          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)`,
          [
            product.name,
            description,
            product.price,
            categoryId,
            bonusPoints,
            product.main_image,
            product.images || [], // –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç–∏–Ω–æ–∫
            product.memory_options || [], // –º–∞—Å—Å–∏–≤ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–∞–º—è—Ç–∏
            colorOptions,
            deliveryArray, // –º–∞—Å—Å–∏–≤ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏ (–∏–∑ –ø–æ–ª—è "delivery")
            50 // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ
          ]
        );
        
        importedCount++;
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 5 —Ç–æ–≤–∞—Ä–æ–≤
        if (importedCount % 5 === 0) {
          console.log(`   –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${importedCount}/${productsData.length}`);
        }
      } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ç–æ–≤–∞—Ä–∞ "${product.name}":`, error.message);
      }
    }
    
    console.log(`\n‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –î–æ–±–∞–≤–ª–µ–Ω–æ ${importedCount} —Ç–æ–≤–∞—Ä–æ–≤`);
    
    // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    console.log('\nüìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:');
    const countResult = await client.query('SELECT COUNT(*) FROM products');
    console.log(`   –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑–µ: ${countResult.rows[0].count}`);
    
    const sampleResult = await client.query('SELECT product_id, name, price FROM products LIMIT 3');
    console.log('\n   –ü—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤:');
    sampleResult.rows.forEach(row => {
      console.log(`   ${row.product_id}. ${row.name} - ${row.price} —Ä—É–±.`);
    });
    
  } catch (error) {
    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
  } finally {
    if (client) client.release();
    await pool.end();
    console.log('\nüîö –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –∑–∞–∫—Ä—ã—Ç–æ');
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∏–º–ø–æ—Ä—Ç
importProducts();